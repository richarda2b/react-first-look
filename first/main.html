<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="main.css">
    <meta charset="utf-8" />
    <title>i'm in a React.app!</title>
  </head>
  <body>
    <div id="React.app"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
    <script type="text/javascript">
      var ContactItem = React.createClass({
        propTypes: {
          name: React.PropTypes.string.isRequired,
          email: React.PropTypes.string.isRequired,
          description: React.PropTypes.string
        },

        render: function() {
          return (
            React.createElement('li', {className: 'ContactItem'},
              React.createElement('h2', {className: 'ContactItem-name'}, this.props.name),
              React.createElement('a', {href: 'mailto:'+this.props.email, className: 'ContactItem-email'}, this.props.email),
              React.createElement('h3', {className: 'ContactItem-description'}, this.props.description)
            )
          )
        }
      })

      var ContactForm = React.createClass({
        propTypes: {
          contact: React.PropTypes.object.isRequired,
          onChange: React.PropTypes.func.isRequired,
          onSubmit: React.PropTypes.func.isRequired
        },

        onNameInputChange: function(event) {
          this.props.onChange(Object.assign({}, this.props.contact, {name: event.target.value}))
        },
        onEmailInputChange: function(event) {
          this.props.onChange(Object.assign({}, this.props.contact, {email: event.target.value}))
        },
        onDescriptionInputChange: function(event) {
          this.props.onChange(Object.assign({}, this.props.contact, {description: event.target.value}))
        },

        render: function() {
          var errors = this.props.contact.errors;

          return (
            React.createElement('form', {className: "ContactForm", onSubmit: this.props.onSubmit},
              React.createElement('input', {
                placeholder: 'Name (Required)',
                type: 'text',
                value: this.props.contact.name,
                className: errors.name && 'ContactForm-error',
                onChange: this.onNameInputChange
              }),
              React.createElement('input', {
                placeholder: 'Email',
                type: 'email',
                value: this.props.contact.email,
                className: errors.email && 'ContactForm-error',
                onChange: this.onEmailInputChange
              }),
              React.createElement('textarea', {
                placeholder: 'Description',
                value: this.props.contact.description,
                onChange: this.onDescriptionInputChange
              }),
              React.createElement('button', {type: "submit"}, 'Add contact')
            )
          )
        }
      })

      var ContactView = React.createClass({
        propTypes: {
          contacts: React.PropTypes.array.isRequired,
          newContact: React.PropTypes.object.isRequired,
          onContactChange: React.PropTypes.func.isRequired,
          onFormSubmit: React.PropTypes.func.isRequired 
        },

        render: function() {
          var contactList = this.props.contacts.filter(contact => contact.email)
                                               .map(contact => React.createElement(ContactItem, contact))

          return (
            React.createElement('div', {className: "ContactView"},
              React.createElement('h1', {className: "ContactView-title"}, "Contacts"),
              React.createElement('ul', {className: "ContactView-list"}, contactList),
              React.createElement(ContactForm, {
                contact: this.props.newContact,
                onChange: this.props.onContactChange,
                onSubmit: this.props.onFormSubmit
              })
            )
          )
        }
      })


      //////////// Actions ////////////

      var contactUpdated = (state) => (contact) => {
        var newState = Object.assign({}, state, {newContact: contact})
        updateTheWorld(newState)
      }

      var submitNewContact = (state) => (event) => {
        event.preventDefault()

        var errors = {
          name: !state.newContact.name ? true : null,
          email: !state.newContact.email ? true : null
        }

        if(!Object.values(errors).find(v => v )) {
          var contact = Object.assign({}, state.newContact, { key: new Date().getTime()})
          var contacts = state.contacts.slice().concat(contact)
          var newState = Object.assign({}, state, {contacts: contacts, newContact: {name: "", email: "", description: "", errors: {}}})
          updateTheWorld(newState)
        } else {
          var contactWithError = Object.assign({}, state.newContact, {errors: errors})
          var newState = Object.assign({}, state, {newContact: contactWithError})
          updateTheWorld(newState)
        }
      }


      ////////// State foo //////////////

      function updateTheWorld(state) {
        var rootElement = React.createElement(ContactView, Object.assign({}, state, {
          onContactChange: contactUpdated(state),
          onFormSubmit: submitNewContact(state)
        }))

        ReactDOM.render(rootElement, document.getElementById('React.app'))
      }

      // Set initial state //
      updateTheWorld(
        {
          contacts: [
            {key: 1, name: "Bob Sponge", email: "bob@example.com", description: "Ninja"},
            {key: 3, name: "Marco Polo", email: "mc@example.com", description: "Animal"},
            {key: 2, name: "Patrik Star", description: "Sea Star!"}
          ],
          newContact: {name: "", email: "", description: "", errors: {}}
        }
      )

    </script>

  </body>

</html>
